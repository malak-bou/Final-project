<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Learning Platform</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="loginForm" class="form-container">
            <h2>Login</h2>
            <form id="loginFormElement">
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
            <p>Don't have an account? <a href="#" id="showRegister">Register</a></p>
        </div>

        <!-- Register Form -->
        <div id="registerForm" class="form-container" style="display: none;">
            <h2>Register</h2>
            <form id="registerFormElement">
                <input type="text" id="fullName" placeholder="Full Name" required>
                <input type="email" id="regEmail" placeholder="Email" required>
                <input type="password" id="regPassword" placeholder="Password" required>
                <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
                <button type="submit">Register</button>
            </form>
            <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
        </div>

        <!-- Main Content (Visible after login) -->
        <div id="mainContent" style="display: none;">
            <header>
                <h1>E-Learning Platform</h1>
                <button id="logoutBtn">Logout</button>
            </header>

            <nav>
                <ul>
                    <li><a href="#" data-section="courses">Courses</a></li>
                    <li><a href="#" data-section="profile">Profile</a></li>
                    <li><a href="#" data-section="conferences">Conferences</a></li>
                    <li><a href="#" data-section="messages">Messages</a></li>
                </ul>
            </nav>

            <main>
                <!-- Courses Section -->
                <section id="courses" class="content-section">
                    <h2>Available Courses</h2>
                    <div id="coursesList"></div>
                </section>

                <!-- Profile Section -->
                <section id="profile" class="content-section" style="display: none;">
                    <h2>My Profile</h2>
                    <div id="profileInfo"></div>
                    <form id="profileForm">
                        <input type="text" id="profileName" placeholder="Full Name">
                        <input type="email" id="profileEmail" placeholder="Email">
                        <button type="submit">Update Profile</button>
                    </form>
                </section>

                <!-- Conferences Section -->
                <section id="conferences" class="content-section" style="display: none;">
                    <h2>Conferences</h2>
                    <button id="requestConferenceBtn">Request New Conference</button>
                    <div id="conferenceRequestForm" style="display: none;">
                        <form id="conferenceForm">
                            <input type="text" id="confName" placeholder="Conference Name" required>
                            <input type="text" id="confDescription" placeholder="Description">
                            <input type="text" id="confLink" placeholder="Conference Link">
                            <input type="text" id="confType" placeholder="Type" required>
                            <input type="text" id="confDepartment" placeholder="Department" required>
                            <input type="date" id="confDate" required>
                            <input type="time" id="confTime" required>
                            <input type="file" id="confImage">
                            <button type="submit">Submit Request</button>
                        </form>
                    </div>
                    <div id="conferencesList"></div>
                </section>

                <!-- Messages Section -->
                <section id="messages" class="content-section" style="display: none;">
                    <h2>Messages</h2>
                    <div id="messagesList"></div>
                    <form id="sendMessageForm">
                        <input type="number" id="receiverId" placeholder="Receiver ID">
                        <textarea id="messageContent" placeholder="Your message"></textarea>
                        <input type="file" id="messageFile">
                        <button type="submit">Send Message</button>
                    </form>
                </section>
            </main>
        </div>
    </div>

    <script type="module">
        import { 
            login, 
            register, 
            getCourses, 
            getUserProfile, 
            updateUserProfile, 
            requestConference, 
            getCalendar, 
            sendMessage, 
            getMessages, 
            isAuthenticated, 
            logout,
            enrollInCourse
        } from './api.js';

        // DOM Elements
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const mainContent = document.getElementById('mainContent');
        const loginFormElement = document.getElementById('loginFormElement');
        const registerFormElement = document.getElementById('registerFormElement');
        const showRegisterLink = document.getElementById('showRegister');
        const showLoginLink = document.getElementById('showLogin');
        const logoutBtn = document.getElementById('logoutBtn');

        // Check if user is already logged in
        if (isAuthenticated()) {
            showMainContent();
        }

        // Event Listeners
        loginFormElement.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                await login(email, password);
                showMainContent();
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        });

        registerFormElement.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const userData = {
                    full_name: document.getElementById('fullName').value,
                    email: document.getElementById('regEmail').value,
                    password: document.getElementById('regPassword').value
                };
                await register(userData);
                showLoginForm();
            } catch (error) {
                alert('Registration failed: ' + error.message);
            }
        });

        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            showRegisterForm();
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            showLoginForm();
        });

        logoutBtn.addEventListener('click', () => {
            logout();
            showLoginForm();
        });

        // Navigation
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.target.dataset.section;
                showSection(section);
            });
        });

        // Add conference request functionality
        const requestConferenceBtn = document.getElementById('requestConferenceBtn');
        const conferenceForm = document.getElementById('conferenceForm');
        const conferenceRequestForm = document.getElementById('conferenceRequestForm');

        requestConferenceBtn.addEventListener('click', () => {
            conferenceRequestForm.style.display = conferenceRequestForm.style.display === 'none' ? 'block' : 'none';
        });

        conferenceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const conferenceData = {
                    name: document.getElementById('confName').value,
                    description: document.getElementById('confDescription').value,
                    link: document.getElementById('confLink').value,
                    type: document.getElementById('confType').value,
                    departement: document.getElementById('confDepartment').value,
                    date: document.getElementById('confDate').value,
                    time: document.getElementById('confTime').value,
                    image: document.getElementById('confImage').files[0]
                };

                await requestConference(conferenceData);
                alert('Conference request submitted successfully!');
                conferenceRequestForm.style.display = 'none';
                loadUserData(); // Refresh the conferences list
            } catch (error) {
                alert('Failed to submit conference request: ' + error.message);
            }
        });

        // Add profile update functionality
        const profileForm = document.getElementById('profileForm');
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const profileData = {
                    full_name: document.getElementById('profileName').value,
                    email: document.getElementById('profileEmail').value
                };

                await updateUserProfile(profileData);
                alert('Profile updated successfully!');
            } catch (error) {
                alert('Failed to update profile: ' + error.message);
            }
        });

        // Add message sending functionality
        const sendMessageForm = document.getElementById('sendMessageForm');
        sendMessageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const receiverId = document.getElementById('receiverId').value;
                const content = document.getElementById('messageContent').value;
                const file = document.getElementById('messageFile').files[0];

                await sendMessage(receiverId, content, file);
                alert('Message sent successfully!');
                document.getElementById('messageContent').value = '';
                document.getElementById('messageFile').value = '';
                loadUserData(); // Refresh the messages list
            } catch (error) {
                alert('Failed to send message: ' + error.message);
            }
        });

        // Helper Functions
        function showMainContent() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'none';
            mainContent.style.display = 'block';
            loadUserData();
        }

        function showLoginForm() {
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            mainContent.style.display = 'none';
        }

        function showRegisterForm() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            mainContent.style.display = 'none';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
        }

        async function loadUserData() {
            try {
                const profile = await getUserProfile();
                document.getElementById('profileName').value = profile.full_name;
                document.getElementById('profileEmail').value = profile.email;
                
                // Load courses
                const courses = await getCourses();
                const coursesList = document.getElementById('coursesList');
                coursesList.innerHTML = courses.map(course => `
                    <div class="course-card">
                        <h3>${course.title}</h3>
                        <p>${course.description}</p>
                        <button onclick="window.enrollInCourse(${course.id})">Enroll</button>
                    </div>
                `).join('');

                // Load messages
                const messages = await getMessages();
                const messagesList = document.getElementById('messagesList');
                messagesList.innerHTML = messages.map(message => `
                    <div class="message">
                        <p>From: ${message.sender_name}</p>
                        <p>${message.content}</p>
                        <small>${new Date(message.created_at).toLocaleString()}</small>
                    </div>
                `).join('');

                // Load conferences
                const conferences = await getCalendar();
                const conferencesList = document.getElementById('conferencesList');
                conferencesList.innerHTML = conferences.map(conf => `
                    <div class="conference-card">
                        <h3>${conf.name}</h3>
                        <p>${conf.description}</p>
                        <p>Date: ${conf.date} ${conf.time}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Make enrollInCourse available globally
        window.enrollInCourse = async (courseId) => {
            try {
                await enrollInCourse(courseId);
                alert('Successfully enrolled in the course!');
                loadUserData(); // Refresh the courses list
            } catch (error) {
                alert('Failed to enroll in course: ' + error.message);
            }
        };
    </script>
</body>
</html> 